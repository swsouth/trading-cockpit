name: Manual Market Scanner

on:
  # AUTOMATIC SCHEDULE DISABLED
  # Reason: Scanner runtime (~65 min) exceeds Netlify function timeout (10-26s)
  # Solution: Run manually via `npm run scan-market` locally or use GitHub Actions manual trigger
  #
  # To re-enable automatic scanning, you would need:
  # 1. A background job service (not serverless functions)
  # 2. OR split the scanner into smaller daily segments
  # 3. OR reduce the stock universe significantly
  #
  # Previous schedule: Mon-Fri at 5:00 PM ET (9:00 PM UTC)
  # schedule:
  #   - cron: '0 21 * * 1-5'

  # Manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  scan-market:
    name: Run Market Scanner
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Scanner API
        run: |
          echo "üöÄ Triggering manual market scan via API..."
          echo "‚ö†Ô∏è  Note: This will timeout (504) because scanner runtime exceeds function timeout"
          echo "    Use 'npm run scan-market' locally instead"

          response=$(curl -s -w "\n%{http_code}" -X POST \
            https://${{ secrets.SITE_URL }}/api/scan/trigger \
            -H "Authorization: Bearer ${{ secrets.SCAN_SECRET_KEY }}" \
            -H "Content-Type: application/json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Market scan completed successfully"
            exit 0
          else
            echo "‚ùå Market scan failed with status $http_code"
            exit 1
          fi

      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå API-triggered scan failed (expected - see timeout note above)"
          echo "To run the scanner successfully, use: npm run scan-market"
          echo "Scanner runtime: ~65 min, Netlify timeout: 10-26s"
